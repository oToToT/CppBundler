name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release Version (e.g. v1.0.0)'
        required: true
      llvm_version:
        description: 'LLVM Version Tag (e.g. llvmorg-21.1.0)'
        required: true
        default: 'llvmorg-21.1.0'

jobs:
  tag_release:
    name: Create Release Tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-linux:
    name: Build Linux (${{ matrix.target }})
    needs: tag_release
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-x64-glibc
            runner: ubuntu-22.04
            container: ubuntu:22.04
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_ZSTD=OFF"
          - target: linux-arm64-glibc
            runner: ubuntu-22.04-arm
            container: ubuntu:22.04
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_ZSTD=OFF"
          - target: linux-x64-musl
            runner: ubuntu-latest
            container: alpine:latest
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_LIBCXX=ON -DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=ON -DLLVM_ENABLE_ZSTD=OFF"
          - target: linux-arm64-musl
            runner: ubuntu-22.04-arm
            container: alpine:latest
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_LIBCXX=ON -DLIBCXX_ENABLE_STATIC_ABI_LIBRARY=ON -DLLVM_ENABLE_ZSTD=OFF"

    steps:
      - name: Set reusable variables
        shell: sh
        run: |
          echo "LLVM_TAG=${{ github.event.inputs.llvm_version || 'llvmorg-21.1.0' }}" >> $GITHUB_ENV
          echo "INSTALL_DIR=${{ github.workspace }}/llvm-install" >> $GITHUB_ENV

      - name: Install Base Dependencies
        run: |
          if [ -f /etc/alpine-release ]; then
            apk add --no-cache git bash nodejs
          else
            apt-get update && apt-get install -y git
          fi
        shell: sh

      - name: Checkout LLVM
        uses: actions/checkout@v4
        with:
          repository: llvm/llvm-project
          ref: ${{ env.LLVM_TAG }}
          path: llvm-project

      - name: Install Build Dependencies
        run: |
          if [ -f /etc/alpine-release ]; then
            apk add --no-cache build-base cmake ninja python3 linux-headers
          else
            apt-get update && apt-get install -y build-essential cmake ninja-build python3
          fi
        shell: sh

      - name: Cache LLVM Build
        id: cache-llvm
        uses: actions/cache@v3
        with:
          path: ${{ env.INSTALL_DIR }}
          # Version 2 cache key for everyone to ensure clean starts on new structure
          key: llvm-${{ env.LLVM_TAG }}-${{ matrix.target }}-v2

      - name: Configure CMake
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake -S llvm-project/llvm -B build \
            -G Ninja \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} \
            ${{ matrix.cmake_flags }}
        shell: sh

      - name: Build and Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake --build build --target install
        shell: sh

      - name: Checkout CppBundler
        uses: actions/checkout@v4
        with:
          path: CppBundler

      - name: Build CppBundler
        run: |
          mkdir build-tool
          cd build-tool
          
          EXTRA_FLAGS="-DUSE_STATIC_CRT=ON"
          if [[ "${{ matrix.target }}" == *"musl"* ]]; then
             EXTRA_FLAGS="-DCMAKE_EXE_LINKER_FLAGS='-static' -DUSE_STATIC_CRT=ON"
          fi

          echo "Building with flags: $EXTRA_FLAGS"

          cmake -S ../CppBundler -B . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_STATIC=ON \
            -DLLVM_DIR=${{ env.INSTALL_DIR }}/lib/cmake/llvm \
            -DClang_DIR=${{ env.INSTALL_DIR }}/lib/cmake/clang \
            $EXTRA_FLAGS
            
          cmake --build .
        shell: sh

      - name: Package Release Asset
        run: |
          BINARY_NAME="cpp-bundle"
          find build-tool -name "$BINARY_NAME" -type f -exec cp {} ./ \;
          ASSET_NAME="cpp-bundle-${{ matrix.target }}"
          mv "$BINARY_NAME" "$ASSET_NAME"
          echo "ASSET_PATH=$(pwd)/$ASSET_NAME" >> $GITHUB_ENV
        shell: sh

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-windows:
    name: Build Windows (${{ matrix.target }})
    needs: tag_release
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: windows-x64
            runner: windows-latest
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_USE_CRT_RELEASE=MT -DLLVM_ENABLE_ZSTD=OFF"
          - target: windows-arm64
            runner: windows-11-arm
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_USE_CRT_RELEASE=MT -DLLVM_ENABLE_ZSTD=OFF"

    steps:
      - name: Set reusable variables
        shell: bash
        run: |
          echo "LLVM_TAG=${{ github.event.inputs.llvm_version || 'llvmorg-21.1.0' }}" >> $GITHUB_ENV
          echo "INSTALL_DIR=${{ github.workspace }}/llvm-install" >> $GITHUB_ENV

      - name: Checkout LLVM
        uses: actions/checkout@v4
        with:
          repository: llvm/llvm-project
          ref: ${{ env.LLVM_TAG }}
          path: llvm-project

      - name: Install Dependencies
        run: choco install ninja
        shell: pwsh

      - name: Cache LLVM Build
        id: cache-llvm
        uses: actions/cache@v3
        with:
          path: ${{ env.INSTALL_DIR }}
          key: llvm-${{ env.LLVM_TAG }}-${{ matrix.target }}

      - name: Configure CMake
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake -S llvm-project/llvm -B build \
            -G Ninja \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} \
            ${{ matrix.cmake_flags }}
        shell: bash

      - name: Build and Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake --build build --target install
        shell: bash

      - name: Checkout CppBundler
        uses: actions/checkout@v4
        with:
          path: CppBundler

      - name: Build CppBundler
        run: |
          mkdir build-tool
          cd build-tool
          
          echo "Building with flags: -DUSE_STATIC_CRT=ON"

          cmake -S ../CppBundler -B . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_STATIC=ON \
            -DLLVM_DIR=${{ env.INSTALL_DIR }}/lib/cmake/llvm \
            -DClang_DIR=${{ env.INSTALL_DIR }}/lib/cmake/clang \
            -DUSE_STATIC_CRT=ON
            
          cmake --build .
        shell: bash

      - name: Package Release Asset
        run: |
          BINARY_NAME="cpp-bundle.exe"
          find build-tool -name "$BINARY_NAME" -type f -exec cp {} ./ \;
          ASSET_NAME="cpp-bundle-${{ matrix.target }}.exe"
          mv "$BINARY_NAME" "$ASSET_NAME"
          echo "ASSET_PATH=$(pwd)/$ASSET_NAME" >> $GITHUB_ENV
        shell: bash

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-macos:
    name: Build macOS (${{ matrix.target }})
    needs: tag_release
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: macos-arm64
            cmake_flags: "-DLLVM_ENABLE_PROJECTS='clang' -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_ZSTD=OFF"

    steps:
      - name: Set reusable variables
        shell: bash
        run: |
          echo "LLVM_TAG=${{ github.event.inputs.llvm_version || 'llvmorg-21.1.0' }}" >> $GITHUB_ENV
          echo "INSTALL_DIR=${{ github.workspace }}/llvm-install" >> $GITHUB_ENV

      - name: Checkout LLVM
        uses: actions/checkout@v4
        with:
          repository: llvm/llvm-project
          ref: ${{ env.LLVM_TAG }}
          path: llvm-project

      - name: Install Dependencies
        run: brew install cmake ninja

      - name: Cache LLVM Build
        id: cache-llvm
        uses: actions/cache@v3
        with:
          path: ${{ env.INSTALL_DIR }}
          key: llvm-${{ env.LLVM_TAG }}-${{ matrix.target }}

      - name: Configure CMake
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake -S llvm-project/llvm -B build \
            -G Ninja \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_DIR }} \
            ${{ matrix.cmake_flags }}
        shell: bash

      - name: Build and Install LLVM
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cmake --build build --target install
        shell: bash

      - name: Checkout CppBundler
        uses: actions/checkout@v4
        with:
          path: CppBundler

      - name: Build CppBundler
        run: |
          mkdir build-tool
          cd build-tool
          
          # No static CRT flag needed for macOS or different handling
          echo "Building for macOS"

          cmake -S ../CppBundler -B . \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_STATIC=ON \
            -DLLVM_DIR=${{ env.INSTALL_DIR }}/lib/cmake/llvm \
            -DClang_DIR=${{ env.INSTALL_DIR }}/lib/cmake/clang \
            
          cmake --build .
        shell: bash

      - name: Package Release Asset
        run: |
          BINARY_NAME="cpp-bundle"
          find build-tool -name "$BINARY_NAME" -type f -exec cp {} ./ \;
          ASSET_NAME="cpp-bundle-${{ matrix.target }}"
          mv "$BINARY_NAME" "$ASSET_NAME"
          echo "ASSET_PATH=$(pwd)/$ASSET_NAME" >> $GITHUB_ENV
        shell: bash

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version }}
          files: ${{ env.ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
